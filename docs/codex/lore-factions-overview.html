<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factions Overview - Penance Codex</title>
    <link rel="stylesheet" href="manuscript-style.css">
    <style>
        /* Faction cards grid */
        .factions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .faction-card {
            background: rgba(10, 6, 4, 0.7);
            border: 1px solid var(--dark-red);
            border-top: 3px solid var(--dark-red);
            padding: 1rem;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .faction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--leather-texture);
            opacity: 0.1;
            pointer-events: none;
        }

        .faction-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(139, 0, 0, 0.5);
            border-top-color: var(--aged-gold);
        }

        .faction-card.active {
            border: 2px solid var(--aged-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
            z-index: 10;
        }

        .faction-name {
            font-family: 'Cinzel', serif;
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--aged-gold);
            margin: 0 0 0.5rem 0;
            letter-spacing: 0.05em;
        }

        .faction-tier {
            display: inline-block;
            background: rgba(139, 0, 0, 0.4);
            border: 1px solid var(--dark-red);
            color: var(--aged-gold);
            padding: 0.2rem 0.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .faction-info {
            font-size: 0.85rem;
            line-height: 1.5;
            opacity: 0.9;
        }

        .faction-info strong {
            color: var(--aged-gold);
            font-size: 0.75rem;
            display: block;
            margin-top: 0.5rem;
        }

        /* Relationship Web */
        .relationship-section {
            margin: 3rem 0;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(75, 14, 14, 0.2), rgba(10, 6, 4, 0.3));
            border: 2px solid var(--dark-red);
        }

        .relationship-web {
            position: relative;
            height: 600px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--dark-red);
            margin: 2rem 0;
            overflow: hidden;
        }

        .web-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(75, 14, 14, 0.9), rgba(139, 0, 0, 0.8));
            border: 2px solid var(--dark-red);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--aged-gold);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
            padding: 0.25rem;
            line-height: 1.2;
        }

        .web-node:hover {
            transform: scale(1.15);
            border-color: var(--aged-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            z-index: 10;
        }

        .web-node.active {
            border: 3px solid var(--aged-gold);
            background: linear-gradient(135deg, rgba(139, 0, 0, 1), rgba(212, 175, 55, 0.3));
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
            transform: scale(1.2);
            z-index: 15;
        }

        .web-connection {
            position: absolute;
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.3s ease;
        }

        .web-connection.ally {
            background: linear-gradient(90deg, rgba(34, 139, 34, 0.6), rgba(34, 139, 34, 0.3));
            box-shadow: 0 0 4px rgba(34, 139, 34, 0.4);
        }

        .web-connection.enemy {
            background: linear-gradient(90deg, rgba(220, 20, 60, 0.6), rgba(220, 20, 60, 0.3));
            box-shadow: 0 0 4px rgba(220, 20, 60, 0.4);
        }

        .web-connection.neutral {
            background: linear-gradient(90deg, rgba(169, 169, 169, 0.4), rgba(169, 169, 169, 0.2));
        }

        .web-connection.hidden {
            opacity: 0.1;
        }

        /* Legend */
        .relationship-legend {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .legend-line {
            width: 40px;
            height: 3px;
        }

        .legend-line.ally {
            background: rgba(34, 139, 34, 0.8);
            box-shadow: 0 0 4px rgba(34, 139, 34, 0.4);
        }

        .legend-line.enemy {
            background: rgba(220, 20, 60, 0.8);
            box-shadow: 0 0 4px rgba(220, 20, 60, 0.4);
        }

        .legend-line.neutral {
            background: rgba(169, 169, 169, 0.6);
        }

        /* Tooltip */
        .faction-tooltip {
            position: absolute;
            background: rgba(10, 6, 4, 0.95);
            border: 2px solid var(--aged-gold);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            border-radius: 4px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .faction-tooltip.visible {
            opacity: 1;
            transform: scale(1);
        }

        .faction-tooltip h3 {
            color: var(--aged-gold);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
        }

        .faction-tooltip p {
            margin: 0.25rem 0;
            line-height: 1.5;
            font-size: 0.85rem;
        }

        .faction-tooltip strong {
            color: var(--aged-gold);
        }

        .relationship-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .relationship-group h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 0 0.25rem 0;
        }

        .relationship-group.allies h4 {
            color: rgb(34, 139, 34);
        }

        .relationship-group.enemies h4 {
            color: rgb(220, 20, 60);
        }

        .relationship-group.neutral h4 {
            color: rgba(169, 169, 169, 0.9);
        }

        .relationship-group ul {
            margin: 0;
            padding-left: 1rem;
            font-size: 0.8rem;
        }

        .relationship-group li {
            margin: 0.2rem 0;
        }

        .tooltip-link {
            display: block;
            text-align: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--dark-red);
        }

        .tooltip-link a {
            color: var(--aged-gold);
            text-decoration: underline;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Draggable cursor */
        .web-node {
            cursor: grab;
        }

        .web-node:active {
            cursor: grabbing;
        }

        .web-node.dragging {
            opacity: 0.7;
            z-index: 20;
        }

        /* Power tier table */
        .power-tier-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 0.9rem;
        }

        .power-tier-table th,
        .power-tier-table td {
            padding: 1rem;
            border: 1px solid var(--dark-red);
            text-align: left;
        }

        .power-tier-table th {
            background: rgba(75, 14, 14, 0.5);
            color: var(--aged-gold);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
        }

        .power-tier-table td {
            background: rgba(10, 6, 4, 0.3);
        }

        .power-tier-table strong {
            color: var(--aged-gold);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .relationship-web {
                height: 400px;
            }

            .web-node {
                width: 60px;
                height: 60px;
                font-size: 0.6rem;
            }

            .factions-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Instructions */
        .web-instructions {
            text-align: center;
            padding: 1rem;
            background: rgba(139, 0, 0, 0.2);
            border: 1px solid var(--dark-red);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .web-instructions strong {
            color: var(--aged-gold);
        }

        /* Reset button */
        .web-controls {
            text-align: center;
            margin-bottom: 1rem;
        }

        .reset-button {
            background: rgba(139, 0, 0, 0.3);
            border: 1px solid var(--dark-red);
            color: var(--aged-gold);
            padding: 0.5rem 1rem;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-button:hover {
            background: rgba(139, 0, 0, 0.5);
            border-color: var(--aged-gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
    </style>
</head>
<body>
    <main class="content" role="main">
        <nav class="breadcrumb" aria-label="Breadcrumb">
            <a href="content-home.html" target="_parent">CODEX</a> /
            <a href="#lore">LORE</a> /
            Factions Overview
        </nav>

        <h1>The Factions: Humanity's Fractured Survival</h1>

        <div class="manuscript-quote">
            "We used to be one species. Now we're ten tribes fighting over the corpse of civilization. Maybe that's progress. Maybe it's just decay."
            <span class="quote-attribution">— Nomad Elder testimony</span>
        </div>

        <p class="manuscript-text">
            When the Sundering shattered civilization, it also shattered humanity's unity. From the ruins emerged ten major factions—each with unique philosophies, resources, and survival strategies. Some seek redemption through faith. Others embrace mutation and evolution. All compete for territory, resources, and the right to define what humanity will become in the centuries ahead.
        </p>

        <div class="divider">❈</div>

        <h2>Faction Power Structure (Year 437)</h2>

        <table class="power-tier-table">
            <thead>
                <tr>
                    <th>Tier</th>
                    <th>Factions</th>
                    <th>Characteristics</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Tier 1: Superpowers</strong></td>
                    <td>Church of Absolution, The Ossuarium</td>
                    <td>Control vast territories, populations 10-20 million, standing armies, industrial capacity</td>
                </tr>
                <tr>
                    <td><strong>Tier 2: Regional Powers</strong></td>
                    <td>Dwarven Forge-Guilds, The Exchange, Elven Verdant Covenant</td>
                    <td>Control key resources/geography, populations 2-5 million, specialized capabilities</td>
                </tr>
                <tr>
                    <td><strong>Tier 3: Minor Factions</strong></td>
                    <td>Nomad Collective, Vestige Bloodlines, Emergent Syndicate, Wyrd Conclave</td>
                    <td>Dispersed/isolated, populations 500k-2 million, guerrilla tactics or niche dominance</td>
                </tr>
                <tr>
                    <td><strong>Tier 4: Outliers</strong></td>
                    <td>Crucible Packs, Draconid Remembrance</td>
                    <td>Specialized/neutral, populations &lt;100k, non-expansionist</td>
                </tr>
            </tbody>
        </table>

        <div class="divider">❈</div>

        <h2>Interactive Faction Relationship Web</h2>

        <div class="relationship-section">
            <div class="web-instructions">
                <strong>Click any faction</strong> to view details | <strong>Drag nodes</strong> to reposition | <strong>Green</strong> = Allies | <strong>Red</strong> = Enemies | <strong>Gray</strong> = Neutral
            </div>

            <div class="web-controls">
                <button class="reset-button" onclick="resetPositions()">Reset Positions</button>
            </div>

            <div class="relationship-web" id="relationshipWeb">
                <!-- Nodes and tooltip will be positioned by JavaScript -->
            </div>

            <div class="relationship-legend">
                <div class="legend-item">
                    <div class="legend-line ally"></div>
                    <span>Alliance / Trade Partners</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line enemy"></div>
                    <span>Active Hostility / War</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line neutral"></div>
                    <span>Neutral / Uneasy Peace</span>
                </div>
            </div>
        </div>

        <div class="divider">❈</div>

        <h2>Faction Quick Reference</h2>

        <div class="factions-grid" id="factionsGrid">
            <!-- Cards will be generated by JavaScript -->
        </div>

        <div class="divider">❈</div>

        <h2>Choose Your Path</h2>

        <p class="manuscript-text">
            Each faction offers a unique playstyle, philosophy, and destiny. Whether you seek redemption through the Church, evolution through the Syndicate, profit through the Exchange, or any other path...the choice shapes not only your campaign but the fate of the world itself.
        </p>

        <p style="text-align: center; margin: 3rem 0; font-size: 1.1rem; color: var(--aged-gold); font-style: italic;">
            "In iron we seek forgiveness. Through blood, absolution."<br>
            <span style="opacity: 0.7; font-size: 0.95rem;">— The Creed of the Bound</span>
        </p>
    </div>

    <script>
        // Faction data
        const factions = {
            'church': {
                name: 'Church of Absolution',
                tier: 'T1',
                page: 'faction-church.html',
                playstyle: 'Aggressive Martyrdom',
                mechanic: 'Blood Offering',
                population: '15-20 million',
                allies: ['dwarves'],
                enemies: ['ossuarium', 'wyrd'],
                neutral: ['elves', 'exchange', 'nomads', 'bloodlines', 'emergent', 'crucible', 'draconid']
            },
            'ossuarium': {
                name: 'The Ossuarium',
                tier: 'T1',
                page: 'faction-undead.html',
                playstyle: 'Necromantic Grinder',
                mechanic: 'Soul Harvest',
                population: '10-15 million',
                allies: ['exchange'],
                enemies: ['church', 'elves'],
                neutral: ['dwarves', 'wyrd', 'nomads', 'bloodlines', 'emergent', 'crucible', 'draconid']
            },
            'dwarves': {
                name: 'Dwarven Forge-Guilds',
                tier: 'T2',
                page: 'faction-dwarves.html',
                playstyle: 'Fortress Defender',
                mechanic: 'Rune Counters',
                population: '3-5 million',
                allies: ['church', 'exchange'],
                enemies: ['emergent'],
                neutral: ['ossuarium', 'elves', 'wyrd', 'nomads', 'bloodlines', 'crucible', 'draconid']
            },
            'exchange': {
                name: 'The Exchange',
                tier: 'T2',
                page: 'faction-exchange.html',
                playstyle: 'Economic Warfare',
                mechanic: 'Credit Tokens',
                population: '2-5 million',
                allies: ['ossuarium', 'dwarves', 'nomads'],
                enemies: [],
                neutral: ['church', 'elves', 'wyrd', 'bloodlines', 'emergent', 'crucible', 'draconid']
            },
            'elves': {
                name: 'Elven Verdant Covenant',
                tier: 'T2',
                page: 'faction-elves.html',
                playstyle: 'Hit-and-Run Assassin',
                mechanic: 'Bleed Stacking',
                population: '2-4 million',
                allies: ['wyrd'],
                enemies: ['ossuarium', 'bloodlines'],
                neutral: ['church', 'dwarves', 'exchange', 'nomads', 'emergent', 'crucible', 'draconid']
            },
            'wyrd': {
                name: 'The Wyrd Conclave',
                tier: 'T3',
                page: 'faction-fae.html',
                playstyle: 'Reality Bender',
                mechanic: 'Wyrd Tokens',
                population: '500k-1 million',
                allies: ['elves'],
                enemies: ['church'],
                neutral: ['ossuarium', 'dwarves', 'exchange', 'nomads', 'bloodlines', 'emergent', 'crucible', 'draconid']
            },
            'nomads': {
                name: 'Nomad Collective',
                tier: 'T3',
                page: 'faction-nomads.html',
                playstyle: 'Mobile Survivor',
                mechanic: 'Improvisation',
                population: '1-2 million',
                allies: ['exchange'],
                enemies: [],
                neutral: ['church', 'ossuarium', 'dwarves', 'elves', 'wyrd', 'bloodlines', 'emergent', 'crucible', 'draconid']
            },
            'bloodlines': {
                name: 'Vestige Bloodlines',
                tier: 'T3',
                page: 'faction-bloodlines.html',
                playstyle: 'Mutation Specialists',
                mechanic: 'Biomass Tokens',
                population: '500k-1 million',
                allies: [],
                enemies: ['elves'],
                neutral: ['church', 'ossuarium', 'dwarves', 'exchange', 'wyrd', 'nomads', 'emergent', 'crucible', 'draconid']
            },
            'emergent': {
                name: 'Emergent Syndicate',
                tier: 'T3',
                page: 'faction-emergent.html',
                playstyle: 'Hive-Mind Collective',
                mechanic: 'Metamorph Tokens',
                population: '1-2 million',
                allies: [],
                enemies: ['dwarves'],
                neutral: ['church', 'ossuarium', 'elves', 'exchange', 'wyrd', 'nomads', 'bloodlines', 'crucible', 'draconid']
            },
            'crucible': {
                name: 'Crucible Packs',
                tier: 'T4',
                page: 'faction-crucible.html',
                playstyle: 'Fire Duelist',
                mechanic: 'Forge Tokens',
                population: '<100k',
                allies: [],
                enemies: [],
                neutral: ['church', 'ossuarium', 'dwarves', 'elves', 'exchange', 'wyrd', 'nomads', 'bloodlines', 'emergent', 'draconid']
            },
            'draconid': {
                name: 'Draconid Remembrance',
                tier: 'T4',
                page: 'faction-draconid.html',
                playstyle: 'Ancient Archivists',
                mechanic: 'Memory Shards',
                population: '<50k',
                allies: [],
                enemies: [],
                neutral: ['church', 'ossuarium', 'dwarves', 'elves', 'exchange', 'wyrd', 'nomads', 'bloodlines', 'emergent', 'crucible']
            }
        };

        // Default node positions (percentage-based)
        const defaultPositions = {
            'church': { x: 50, y: 10 },      // Top center
            'ossuarium': { x: 85, y: 25 },   // Top right
            'dwarves': { x: 90, y: 50 },     // Right
            'exchange': { x: 80, y: 75 },    // Bottom right
            'elves': { x: 50, y: 90 },       // Bottom
            'wyrd': { x: 20, y: 75 },        // Bottom left
            'nomads': { x: 10, y: 50 },      // Left
            'bloodlines': { x: 20, y: 25 },  // Top left
            'emergent': { x: 35, y: 50 },    // Inner left
            'crucible': { x: 65, y: 50 },    // Inner right
            'draconid': { x: 50, y: 50 }     // Center
        };

        // Load saved positions or use defaults
        let nodePositions = { ...defaultPositions };
        try {
            const saved = localStorage.getItem('factionNodePositions');
            if (saved) {
                nodePositions = { ...defaultPositions, ...JSON.parse(saved) };
            }
        } catch (e) {
            console.warn('Failed to load saved positions:', e);
        }

        let activeNode = null;
        let dragState = {
            isDragging: false,
            draggedNode: null,
            startX: 0,
            startY: 0,
            offsetX: 0,
            offsetY: 0,
            hasMoved: false
        };

        let tooltip = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createWeb();
            createCards();
        });

        function createWeb() {
            const web = document.getElementById('relationshipWeb');
            const rect = web.getBoundingClientRect();

            // Create connections first (so they're behind nodes)
            Object.keys(factions).forEach(factionId => {
                const faction = factions[factionId];
                const fromPos = nodePositions[factionId];
                const fromX = (fromPos.x / 100) * rect.width;
                const fromY = (fromPos.y / 100) * rect.height;

                // Draw ally connections
                faction.allies.forEach(allyId => {
                    if (factions[allyId]) {
                        const toPos = nodePositions[allyId];
                        const toX = (toPos.x / 100) * rect.width;
                        const toY = (toPos.y / 100) * rect.height;
                        createConnection(fromX, fromY, toX, toY, 'ally', factionId, allyId);
                    }
                });

                // Draw enemy connections
                faction.enemies.forEach(enemyId => {
                    if (factions[enemyId]) {
                        const toPos = nodePositions[enemyId];
                        const toX = (toPos.x / 100) * rect.width;
                        const toY = (toPos.y / 100) * rect.height;
                        createConnection(fromX, fromY, toX, toY, 'enemy', factionId, enemyId);
                    }
                });
            });

            // Create nodes
            Object.keys(factions).forEach(factionId => {
                const faction = factions[factionId];
                const pos = nodePositions[factionId];

                const node = document.createElement('div');
                node.className = 'web-node';
                node.dataset.faction = factionId;
                node.style.left = `calc(${pos.x}% - 40px)`;
                node.style.top = `calc(${pos.y}% - 40px)`;
                node.textContent = faction.name;

                // Add drag handlers
                node.addEventListener('mousedown', startDrag);
                node.addEventListener('click', (e) => {
                    if (!dragState.hasMoved) {
                        selectFaction(factionId);
                    }
                });

                web.appendChild(node);
            });

            // Create tooltip
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'faction-tooltip';
                web.appendChild(tooltip);
            }

            // Add global drag handlers
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
        }

        function createConnection(x1, y1, x2, y2, type, from, to) {
            const web = document.getElementById('relationshipWeb');
            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);

            const line = document.createElement('div');
            line.className = `web-connection ${type}`;
            line.dataset.from = from;
            line.dataset.to = to;
            line.style.width = `${length}px`;
            line.style.left = `${x1}px`;
            line.style.top = `${y1}px`;
            line.style.transform = `rotate(${angle}deg)`;

            web.appendChild(line);
        }

        function selectFaction(factionId) {
            const faction = factions[factionId];
            if (!faction) return;

            // Update active node
            document.querySelectorAll('.web-node').forEach(node => {
                node.classList.remove('active');
            });
            const selectedNode = document.querySelector(`.web-node[data-faction="${factionId}"]`);
            if (selectedNode) {
                selectedNode.classList.add('active');
            }

            // Highlight relevant connections
            document.querySelectorAll('.web-connection').forEach(conn => {
                const from = conn.dataset.from;
                const to = conn.dataset.to;
                if (from === factionId || to === factionId) {
                    conn.classList.remove('hidden');
                } else {
                    conn.classList.add('hidden');
                }
            });

            // Show tooltip near the node
            if (tooltip && selectedNode) {
                const web = document.getElementById('relationshipWeb');
                const webRect = web.getBoundingClientRect();
                const nodeRect = selectedNode.getBoundingClientRect();

                tooltip.innerHTML = `
                    <h3>${faction.name}</h3>
                    <p><strong>Tier:</strong> ${faction.tier} | <strong>Playstyle:</strong> ${faction.playstyle}</p>
                    <p><strong>Population:</strong> ${faction.population}</p>
                    <div class="relationship-list">
                        ${faction.allies.length > 0 ? `
                            <div class="relationship-group allies">
                                <h4>Allies</h4>
                                <ul>
                                    ${faction.allies.map(id => `<li>${factions[id].name}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${faction.enemies.length > 0 ? `
                            <div class="relationship-group enemies">
                                <h4>Enemies</h4>
                                <ul>
                                    ${faction.enemies.map(id => `<li>${factions[id].name}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${faction.neutral.length > 0 ? `
                            <div class="relationship-group neutral">
                                <h4>Neutral</h4>
                                <ul>
                                    ${faction.neutral.slice(0, 3).map(id => `<li>${factions[id].name}</li>`).join('')}
                                    ${faction.neutral.length > 3 ? `<li>...and ${faction.neutral.length - 3} others</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Position tooltip near the node (prefer right side)
                const tooltipWidth = 350;
                const tooltipHeight = tooltip.offsetHeight || 250;
                const nodeX = nodeRect.left - webRect.left + nodeRect.width / 2;
                const nodeY = nodeRect.top - webRect.top + nodeRect.height / 2;

                let left = nodeX + 50;
                let top = nodeY - tooltipHeight / 2;

                // Keep tooltip within web bounds
                if (left + tooltipWidth > webRect.width - 20) {
                    left = nodeX - tooltipWidth - 50; // Show on left side
                }
                if (top < 20) top = 20;
                if (top + tooltipHeight > webRect.height - 20) {
                    top = webRect.height - tooltipHeight - 20;
                }

                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;
                tooltip.classList.add('visible');
            }

            // Highlight card
            document.querySelectorAll('.faction-card').forEach(card => {
                card.classList.remove('active');
            });
            const selectedCard = document.querySelector(`.faction-card[data-faction="${factionId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }

            activeNode = factionId;
        }

        function createCards() {
            const grid = document.getElementById('factionsGrid');

            Object.keys(factions).forEach(factionId => {
                const faction = factions[factionId];

                const card = document.createElement('div');
                card.className = 'faction-card';
                card.dataset.faction = factionId;
                card.onclick = () => {
                    window.parent.location.href = faction.page;
                };

                card.innerHTML = `
                    <div class="faction-tier">${faction.tier}</div>
                    <h3 class="faction-name">${faction.name}</h3>
                    <div class="faction-info">
                        <strong>Playstyle:</strong> ${faction.playstyle}<br>
                        <strong>Mechanic:</strong> ${faction.mechanic}<br>
                        <strong>Population:</strong> ${faction.population}
                    </main>
                `;

                grid.appendChild(card);
            });
        }

        // Drag handlers
        function startDrag(e) {
            e.preventDefault();
            const node = e.target;
            const factionId = node.dataset.faction;
            if (!factionId) return;

            const web = document.getElementById('relationshipWeb');
            const webRect = web.getBoundingClientRect();
            const nodeRect = node.getBoundingClientRect();

            dragState.isDragging = true;
            dragState.draggedNode = factionId;
            dragState.startX = e.clientX;
            dragState.startY = e.clientY;
            dragState.offsetX = nodeRect.left - webRect.left + nodeRect.width / 2;
            dragState.offsetY = nodeRect.top - webRect.top + nodeRect.height / 2;
            dragState.hasMoved = false;

            node.classList.add('dragging');

            // Hide tooltip while dragging
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }

        function drag(e) {
            if (!dragState.isDragging) return;

            const web = document.getElementById('relationshipWeb');
            const webRect = web.getBoundingClientRect();

            const dx = e.clientX - dragState.startX;
            const dy = e.clientY - dragState.startY;

            // Check if user has moved more than 5 pixels (indicates drag, not click)
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                dragState.hasMoved = true;
            }

            const newX = dragState.offsetX + dx;
            const newY = dragState.offsetY + dy;

            // Convert to percentage
            const percentX = (newX / webRect.width) * 100;
            const percentY = (newY / webRect.height) * 100;

            // Clamp to bounds (5% to 95% to keep within container)
            const clampedX = Math.max(5, Math.min(95, percentX));
            const clampedY = Math.max(5, Math.min(95, percentY));

            // Update position
            nodePositions[dragState.draggedNode] = { x: clampedX, y: clampedY };

            // Update node position
            const node = document.querySelector(`.web-node[data-faction="${dragState.draggedNode}"]`);
            if (node) {
                node.style.left = `calc(${clampedX}% - 40px)`;
                node.style.top = `calc(${clampedY}% - 40px)`;
            }

            // Update all connections
            updateConnections();
        }

        function endDrag(e) {
            if (!dragState.isDragging) return;

            const node = document.querySelector(`.web-node[data-faction="${dragState.draggedNode}"]`);
            if (node) {
                node.classList.remove('dragging');
            }

            // Save positions to localStorage
            try {
                localStorage.setItem('factionNodePositions', JSON.stringify(nodePositions));
            } catch (e) {
                console.warn('Failed to save positions:', e);
            }

            dragState.isDragging = false;
            dragState.draggedNode = null;

            // Reset hasMoved after a brief delay to allow click handler to check it
            setTimeout(() => {
                dragState.hasMoved = false;
            }, 50);
        }

        function updateConnections() {
            const web = document.getElementById('relationshipWeb');
            const webRect = web.getBoundingClientRect();

            // Remove old connections
            document.querySelectorAll('.web-connection').forEach(conn => conn.remove());

            // Redraw all connections
            Object.keys(factions).forEach(factionId => {
                const faction = factions[factionId];
                const fromPos = nodePositions[factionId];
                const fromX = (fromPos.x / 100) * webRect.width;
                const fromY = (fromPos.y / 100) * webRect.height;

                // Draw ally connections
                faction.allies.forEach(allyId => {
                    if (factions[allyId]) {
                        const toPos = nodePositions[allyId];
                        const toX = (toPos.x / 100) * webRect.width;
                        const toY = (toPos.y / 100) * webRect.height;
                        createConnection(fromX, fromY, toX, toY, 'ally', factionId, allyId);
                    }
                });

                // Draw enemy connections
                faction.enemies.forEach(enemyId => {
                    if (factions[enemyId]) {
                        const toPos = nodePositions[enemyId];
                        const toX = (toPos.x / 100) * webRect.width;
                        const toY = (toPos.y / 100) * webRect.height;
                        createConnection(fromX, fromY, toX, toY, 'enemy', factionId, enemyId);
                    }
                });
            });

            // Reapply hidden state based on active node
            if (activeNode) {
                document.querySelectorAll('.web-connection').forEach(conn => {
                    const from = conn.dataset.from;
                    const to = conn.dataset.to;
                    if (from !== activeNode && to !== activeNode) {
                        conn.classList.add('hidden');
                    }
                });
            }
        }

        function resetPositions() {
            nodePositions = { ...defaultPositions };

            // Clear localStorage
            try {
                localStorage.removeItem('factionNodePositions');
            } catch (e) {
                console.warn('Failed to clear saved positions:', e);
            }

            // Rebuild web
            const web = document.getElementById('relationshipWeb');
            web.innerHTML = '';
            tooltip = null;
            createWeb();

            // Hide tooltip
            if (tooltip) {
                tooltip.classList.remove('visible');
            }

            activeNode = null;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const web = document.getElementById('relationshipWeb');
            web.innerHTML = '';
            tooltip = null;
            createWeb();
            if (activeNode) {
                selectFaction(activeNode);
            }
        });

        // Hide tooltip when clicking outside
        document.addEventListener('click', (e) => {
            if (tooltip && !e.target.closest('.web-node') && !e.target.closest('.faction-card')) {
                tooltip.classList.remove('visible');
                activeNode = null;

                // Clear active states
                document.querySelectorAll('.web-node').forEach(node => {
                    node.classList.remove('active');
                });
                document.querySelectorAll('.web-connection').forEach(conn => {
                    conn.classList.remove('hidden');
                });
                document.querySelectorAll('.faction-card').forEach(card => {
                    card.classList.remove('active');
                });
            }
        });
    </script>
    <script src="codex-common.js"></script>
</body>
</html>
