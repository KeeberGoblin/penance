<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penance: Manuscript of Caskets and Bound Souls</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon.png">
    
    <link rel="stylesheet" href="manuscript-style.css">
    <style>
        /* Ensure full-height layout chain */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: row;
        }

        /* Allow sidebar to scroll */
        .sidebar {
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Make content area fill available space */
        .content {
            padding: 0;
            max-width: none;
            background: transparent;
            box-shadow: none;
            height: 100%;
            overflow: hidden;
            flex: 1;
        }

        /* Iframe with full-height matching */
        .content-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #D4C5B0;
            display: block;
        }

        .content::before {
            display: none;
        }

        /* Active link styling */
        .nav-link.active {
            border-left-color: var(--bone-white);
            font-weight: 700;
            background: rgba(75, 14, 14, 0.3);
        }

        /* Dropdown menu styling */
        .nav-dropdown {
            position: relative;
        }

        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            padding-left: 1rem;
            margin-left: 0.5rem;
            border-left: 2px solid var(--dark-red);
            opacity: 0;
            transform: translateY(-10px);
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease,
                        transform 0.3s ease;
        }

        .nav-dropdown:hover .nav-submenu,
        .nav-dropdown.dropdown-open .nav-submenu {
            max-height: 500px;
            opacity: 1;
            transform: translateY(0);
            margin-top: 0.25rem;
        }

        .nav-submenu .nav-link {
            font-size: 1.1rem;
            padding: 0.4rem 0.75rem;
            opacity: 0.85;
            transition: opacity 0.2s ease, padding-left 0.3s ease;
        }

        .nav-submenu .nav-link:hover {
            opacity: 1;
        }

        .nav-link.has-submenu::after {
            content: '▼';
            font-size: 0.6rem;
            margin-left: 0.5rem;
            opacity: 0.5;
            transition: transform 0.3s ease;
        }

        .nav-dropdown:hover .nav-link.has-submenu::after,
        .nav-dropdown.dropdown-open .nav-link.has-submenu::after {
            transform: rotate(180deg);
        }

        /* When open, show a divider in place of parent text and disable navigation */
        .nav-dropdown > .nav-link.has-submenu { position: relative; }
        .nav-dropdown.dropdown-open > .nav-link.has-submenu { color: transparent; }
        .nav-dropdown.dropdown-open > .nav-link.has-submenu::before {
            content: '────────────';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--aged-gold);
            opacity: 0.7;
        }

        /* Mobile Hamburger Menu */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10001;
            background: var(--blood-red);
            border: 2px solid var(--dark-red);
            color: var(--bone-white);
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
            line-height: 1;
        }

        .mobile-menu-toggle:hover {
            background: var(--dark-red);
            transform: scale(1.05);
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Desktop sidebar toggle - same overlay style as mobile */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 350px;
            height: 100vh;
            z-index: 10000;
            transition: left 0.3s ease;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove any borders from nav sections */
        .nav-section {
            border: none !important;
            border-bottom: 1px solid var(--blood-red) !important;
        }

        .sidebar.active {
            left: 0;
        }

        /* Navigation content wrapper - scrollable area with background */
        .nav-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 7rem;
            padding-bottom: 2rem;
            scrollbar-width: thin;
            scrollbar-color: var(--blood-red) var(--shadow-black);
            background: linear-gradient(to bottom,
                rgba(43, 31, 23, 0.98),
                rgba(26, 20, 16, 0.98)
            );
            position: relative;
            border: none;
            box-shadow: none;
        }

        .nav-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--leather-texture);
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        .nav-content::-webkit-scrollbar {
            width: 10px;
        }

        .nav-content::-webkit-scrollbar-track {
            background: var(--shadow-black);
        }

        .nav-content::-webkit-scrollbar-thumb {
            background: var(--blood-red);
            border-radius: 2px;
        }

        .nav-content::-webkit-scrollbar-thumb:hover {
            background: var(--dark-red);
        }

        /* First ribbon at end of navigation content */
        .nav-end-ribbon {
            width: 100%;
            min-height: 60px;
            background: linear-gradient(to bottom,
                var(--blood-red) 0%,
                var(--dark-red) 100%
            );
            border-top: 3px double var(--aged-gold);
            border-right: none;
            border-bottom: none;
            border-left: none;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.8), inset 0 0 0 transparent;
            flex-shrink: 0;
            position: relative;
            clip-path: polygon(
                0 0,
                100% 0,
                100% calc(100% - 5px),
                60% calc(100% - 5px),
                50% 100%,
                40% calc(100% - 5px),
                0 calc(100% - 5px)
            );
            height: 60px;
            margin-bottom: -5px; /* Slight overlap */
        }

        /* Second bookmark ribbon at bottom of sidebar */
        .sidebar-bookmark {
            position: sticky;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to bottom,
                var(--blood-red) 0%,
                var(--dark-red) 100%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 3px double var(--aged-gold);
            border-right: none;
            border-bottom: none;
            border-left: none;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.8), inset 0 0 0 transparent;
            margin-top: auto;
            flex-shrink: 0;
            position: relative;
            clip-path: polygon(
                0 0,
                100% 0,
                100% 75%,
                60% 75%,
                50% 100%,
                40% 75%,
                0 75%
            );
        }

        .sidebar-bookmark::after {
            content: '⸸';
            font-size: 2rem;
            color: var(--aged-gold);
            opacity: 0.6;
            z-index: 1;
            margin-bottom: 15px;
        }

        /* Desktop Menu Toggle Button - persistent on left side */
        .desktop-menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10001;
            background: var(--blood-red);
            border: 2px solid var(--dark-red);
            color: var(--bone-white);
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
            line-height: 1;
        }

        .desktop-menu-toggle:hover {
            background: var(--dark-red);
            transform: scale(1.05);
        }

        .desktop-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Backdrop for desktop menu */
        .menu-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
        }

        .menu-backdrop.active {
            display: block;
        }

        /* Adjust container for overlay sidebar */
        .container {
            grid-template-columns: 1fr;
        }

        /* Mobile adjustments */
        @media (max-width: 968px) {
            .sidebar {
                width: 80%;
                max-width: 280px;
            }
        }

        /* Sidebar quick search */
        .nav-search {
            position: sticky;
            top: 0;
            z-index: 2;
            background: linear-gradient(to bottom, rgba(43,31,23,0.98), rgba(26,20,16,0.98));
            padding: 0.75rem;
            border-bottom: 1px solid rgba(139,0,0,0.35);
        }
        .nav-search input[type="text"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgba(10,6,4,0.6);
            border: 1px solid rgba(139,0,0,0.4);
            color: var(--parchment);
            border-radius: 4px;
            font-size: 0.95rem;
        }
        .nav-search-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .nav-search-controls button {
            flex: 1;
            padding: 0.4rem 0.5rem;
            background: var(--blood-red);
            color: var(--bone-white);
            border: 1px solid var(--dark-red);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .nav-search-controls button:hover { background: var(--dark-red); }
        .nav-link.match { background: rgba(75,14,14,0.25); }
    .nav-link .nav-highlight { color: var(--aged-gold); text-decoration: underline dotted; }

        /* Back-to-top floating action button (applies to all pages via iframe control) */
        .back-to-top-fab {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 11000;
            background: var(--blood-red);
            color: var(--bone-white);
            border: 2px solid var(--dark-red);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.2s ease;
        }
        .back-to-top-fab:hover { transform: translateY(-2px); }
        .back-to-top-fab.visible {
            opacity: 0.9;
            pointer-events: auto;
        }

        /* Accessibility: clear focus outline for keyboard users */
        .nav-link:focus-visible,
        .desktop-menu-toggle:focus-visible,
        .back-to-top-fab:focus-visible,
        .nav-search-controls button:focus-visible,
        .nav-search input[type="text"]:focus-visible {
            outline: 2px solid var(--aged-gold);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Skip to content for keyboard users -->
    <a href="#content" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" onfocus="this.style.left='20px'" onblur="this.style.left='-9999px'">Skip to content</a>
    <!-- Menu Toggle Button (works for both desktop and mobile) -->
    <button class="desktop-menu-toggle" onclick="toggleMenu()" aria-label="Open menu">☰</button>

    <!-- Menu Backdrop -->
    <div class="menu-backdrop" onclick="toggleMenu()"></div>

    <!-- Falling ash/dust particles -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title">PENANCE</div>
        <div class="header-subtitle">Codex of the Bound • Chronicle of Iron and Blood</div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="nav-content">
            <div class="nav-search">
                <input id="navSearchInput" type="text" placeholder="Search Codex..." aria-label="Search Codex navigation" />
                <div class="nav-search-controls">
                    <button type="button" id="expandAllBtn">Expand All</button>
                    <button type="button" id="collapseAllBtn">Collapse All</button>
                    <button type="button" id="clearSearchBtn">Clear</button>
                </div>
            </div>
            <!-- 0. HOME - Quick return to index -->
            <div class="nav-section">
                <a class="nav-link" style="font-weight: 700; color: var(--aged-gold); border-left-color: var(--dark-red);" onclick="loadContent('content-home.html', event)">CODEX HOME</a>
            </div>

            <!-- 1. LORE & WORLD (Context First) -->
            <div class="nav-section">
                <div class="nav-title">Lore & World</div>

                <!-- The Theslar Event submenu -->
                <div class="nav-dropdown">
                    <a class="nav-link has-submenu" data-url="lore-theslar-overview.html">The Theslar Event</a>
                    <div class="nav-submenu">
                        <a class="nav-link" onclick="loadContent('lore-ground-zero.html', event)">Ground Zero (North Pole)</a>
                        <a class="nav-link" onclick="loadContent('lore-year-zero.html', event)">Year 0 Timeline</a>
                        <a class="nav-link" onclick="loadContent('lore-engine.html', event)">The Engine Itself</a>
                        <a class="nav-link" onclick="loadContent('lore-pre-sundering.html', event)">Before the Fall</a>
                    </div>
                </div>

                <!-- Casket Technology submenu -->
                <div class="nav-dropdown">
                    <a class="nav-link has-submenu" data-url="lore-caskets-overview.html">Casket Technology</a>
                    <div class="nav-submenu">
                        <a class="nav-link" onclick="loadContent('lore-casket-origins.html', event)">Origins & History</a>
                        <a class="nav-link" onclick="loadContent('lore-soulstone-system.html', event)">Soulstone Power System</a>
                        <a class="nav-link" onclick="loadContent('lore-soulstone-volatility.html', event)">Soulstone Volatility</a>
                        <a class="nav-link" onclick="loadContent('lore-neural-threads.html', event)">Neural Thread Interface</a>
                        <a class="nav-link" onclick="loadContent('lore-soul-binding.html', event)">Soul-Binding Mechanics</a>
                        <a class="nav-link" onclick="loadContent('lore-casket-manufacturing.html', event)">Modern Manufacturing</a>
                        <a class="nav-link" onclick="loadContent('lore-bonelord-karath.html', event)">Bonelord Karath</a>
                    </div>
                </div>

                <!-- The World submenu -->
                <div class="nav-dropdown">
                    <a class="nav-link has-submenu" data-url="cosmology.html">The World</a>
                    <div class="nav-submenu">
                        <a class="nav-link" onclick="loadContent('lore-climate.html', event)">Climate & Geography</a>
                        <a class="nav-link" onclick="loadContent('lore-void.html', event)">The Void</a>
                        <a class="nav-link" onclick="loadContent('lore-factions-overview.html', event)">Faction Politics</a>
                        <a class="nav-link" onclick="loadContent('lore-settlements.html', event)">Major Settlements</a>
                    </div>
                </div>

                <a class="nav-link" onclick="loadContent('lore-chronicle.html', event)">Chronicle (437 Years)</a>
                <a class="nav-link" onclick="loadContent('lore-npcs.html', event)">Iconic Pilots</a>
            </div>

            <!-- 2. CORE RULES (Learn to Play) -->
            <div class="nav-section">
                <div class="nav-title">Core Rules</div>
                <a class="nav-link" onclick="loadContent('rules-turn-structure.html', event)">Turn Structure</a>
                <a class="nav-link" onclick="loadContent('rules-combat.html', event)">Combat System</a>

                <!-- Component Damage submenu -->
                <div class="nav-dropdown">
                    <a class="nav-link has-submenu" data-url="rules-component-damage.html">Component Damage System</a>
                    <div class="nav-submenu">
                        <a class="nav-link" onclick="loadContent('rules-scrap-cards.html', event)">SCRAP Cards & Salvage</a>
                        <a class="nav-link" onclick="loadContent('rules-thread-snap.html', event)">Thread Snap Damage</a>
                    </div>
                </div>

                <a class="nav-link" onclick="loadContent('rules-soulstone-energy.html', event)">Soulstone Energy System</a>
                <a class="nav-link" onclick="loadContent('rules-range-los.html', event)">Range & Line of Sight</a>
                <a class="nav-link" onclick="loadContent('rules-terrain.html', event)">Terrain</a>
                <a class="nav-link" onclick="loadContent('rules-deck-construction.html', event)">Deck Construction</a>
                <a class="nav-link" onclick="loadContent('support-units.html', event)">Support Units System</a>
                <a class="nav-link" onclick="loadContent('rules-support-as-main.html', event)">Support as Main (Optional)</a>
                <a class="nav-link" onclick="loadContent('rules-dice.html', event)">Dice Reference</a>
                <a class="nav-link" onclick="loadContent('rules-quick-ref.html', event)">Quick Reference</a>
                <a class="nav-link" onclick="loadContent('rules-combat-flowchart.html', event)">Combat Flowchart</a>
                <a class="nav-link" onclick="loadContent('rules-common-mistakes.html', event)">Common Mistakes</a>
                <a class="nav-link" onclick="loadContent('rules-v3-optional.html', event)">v3.0 Optional Rules</a>
            </div>

            <!-- 3. PLAYABLE FACTIONS (Choose Your Army) -->
            <div class="nav-section">
                <div class="nav-title">Playable Factions</div>
                <a class="nav-link" onclick="loadContent('faction-church.html', event)">Church of Absolution</a>
                <a class="nav-link" onclick="loadContent('faction-dwarves.html', event)">Dwarven Forge-Guilds</a>
                <a class="nav-link" onclick="loadContent('faction-undead.html', event)">The Ossuarium</a>
                <a class="nav-link" onclick="loadContent('faction-elves.html', event)">Elven Verdant Covenant</a>
                <a class="nav-link" onclick="loadContent('faction-nomads.html', event)">Nomad Collective</a>
                <a class="nav-link" onclick="loadContent('faction-exchange.html', event)">The Exchange</a>
                <a class="nav-link" onclick="loadContent('faction-bloodlines.html', event)">Vestige Bloodlines</a>
                <a class="nav-link" onclick="loadContent('faction-emergent.html', event)">Emergent Syndicate</a>
                <a class="nav-link" onclick="loadContent('faction-crucible.html', event)">Crucible Packs</a>
                <a class="nav-link" onclick="loadContent('faction-fae.html', event)">The Wyrd Conclave</a>
            </div>

            <!-- 4. SCENARIOS (Start Playing) -->
            <div class="nav-section">
                <div class="nav-title">Scenarios</div>
                <div class="nav-dropdown">
                    <a class="nav-link has-submenu" data-url="scenarios.html">Scenario Overview</a>
                    <div class="nav-submenu">
                        <a class="nav-link" onclick="loadContent('scenario-tutorial-energy-threads.html', event)">Tutorial: Energy & Threads</a>
                        <a class="nav-link" onclick="loadContent('scenario-proving-grounds.html', event)">Scenario #1: Proving Grounds</a>
                        <a class="nav-link" onclick="loadContent('scenario-reliquary-ruins.html', event)">Scenario #2: Reliquary Ruins</a>
                        <a class="nav-link" onclick="loadContent('scenario-escort-duty.html', event)">Scenario #3: Escort Duty</a>
                        <a class="nav-link" onclick="loadContent('scenario-king-of-the-hill.html', event)">Scenario #4: King of the Hill</a>
                        <a class="nav-link" onclick="loadContent('scenario-sabotage-mission.html', event)">Scenario #5: Sabotage Mission</a>
                        <a class="nav-link" onclick="loadContent('scenario-example-of-play.html', event)">Example of Play</a>
                        <a class="nav-link" onclick="loadContent('scenario-boss-iron-saint.html', event)">Boss: The Iron Saint</a>
                    </div>
                </div>
            </div>

            <!-- 5. CAMPAIGN (Long-Term Play) -->
            <div class="nav-section">
                <div class="nav-title">Campaign</div>
                <a class="nav-link" onclick="loadContent('campaign-settlement-phase.html', event)">Settlement Phase Procedure</a>
                <a class="nav-link" onclick="loadContent('campaign-settlements.html', event)">Settlements</a>
                <a class="nav-link" onclick="loadContent('campaign-pilot-generation.html', event)">Pilot Generation Tables</a>
                <a class="nav-link" onclick="loadContent('campaign-pilot-progression.html', event)">Pilot Progression</a>
                <a class="nav-link" onclick="loadContent('campaign-pilot-skills.html', event)">Pilot Skills System</a>
                <a class="nav-link" onclick="loadContent('campaign-flesh-bargains.html', event)">Flesh Bargain</a>
                <a class="nav-link" onclick="loadContent('campaign-mission-generation.html', event)">Mission Generation System</a>
                <a class="nav-link" onclick="loadContent('enemies-bestiary.html', event)">Core Bestiary</a>
                <a class="nav-link" onclick="loadContent('enemies-anomalous.html', event)">Anomalous Bestiary</a>
                <a class="nav-link" onclick="loadContent('campaign-event-tables.html', event)">Event Tables</a>
                <a class="nav-link" onclick="loadContent('campaign-anomalous-events.html', event)">Anomalous Events</a>
                <a class="nav-link" onclick="loadContent('campaign-loot-tables.html', event)">Loot Tables</a>
            </div>

            <!-- 6. NPC-ONLY FACTIONS (Event Encounters) -->
            <div class="nav-section">
                <div class="nav-title">NPC-Only Factions</div>
                <a class="nav-link" onclick="loadContent('faction-draconid.html', event)">The Draconid Remembrance</a>
            </div>


            <!-- 7. RESOURCES -->
            <div class="nav-section">
                <div class="nav-title">Resources</div>
                <a href="../index.html" class="nav-link">Main Site</a>
                <a href="../pdfs/reference-PLAYTEST-READY.pdf" class="nav-link" download>Playtest PDF</a>
                <a href="../cards/" class="nav-link">Card Database</a>
                <a href="../cards/deck-builder.html" class="nav-link">Deck Builder</a>
                <a href="../codex/gm-helper.html" class="nav-link">GM Helper Tool</a>
                <a href="../codex/support-equipment.html" class="nav-link">Support Unit & Equipment Helper</a>
                <a href="https://github.com/KeeberGoblin/penance" class="nav-link" target="_blank" rel="noopener noreferrer">GitHub Repository</a>
            </div>
            </div>

            <!-- First ribbon at end of navigation -->
            <div class="nav-end-ribbon"></div>

            <!-- Second bookmark ribbon at very bottom -->
            <div class="sidebar-bookmark"></div>
        </nav>

        <!-- Content Frame -->
        <main class="content">
            <iframe id="contentFrame" class="content-frame" src="content-home.html" title="Codex content" tabindex="-1"></iframe>
        </main>
    </div>

    <!-- Global Back-to-Top control (acts on iframe content) -->
    <button class="back-to-top-fab" id="backToTopBtn" title="Back to top" aria-label="Back to top" role="button">^ Back to top</button>

    <script>
        function toggleMenu() {
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.querySelector('.menu-backdrop');
            const toggleBtn = document.querySelector('.desktop-menu-toggle');

            sidebar.classList.toggle('active');
            backdrop.classList.toggle('active');

            // Change icon based on menu state
            if (sidebar.classList.contains('active')) {
                toggleBtn.innerHTML = '✕';
                toggleBtn.setAttribute('aria-label', 'Close menu');
            } else {
                toggleBtn.innerHTML = '☰';
                toggleBtn.setAttribute('aria-label', 'Open menu');
            }
        }

        function loadContent(url, event) {
            // Prevent default link behavior and stop event bubbling
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            // Check if this is a dropdown parent link
            const clickedLink = event ? event.currentTarget : null;
            const isDropdownParent = clickedLink && clickedLink.classList.contains('has-submenu');
            const parentDropdown = clickedLink ? clickedLink.closest('.nav-dropdown') : null;

            // Parent links act as toggles ONLY (never navigate); navigation via submenu
            if (isDropdownParent && parentDropdown) {
                const isOpen = parentDropdown.classList.contains('dropdown-open');
                // Close other dropdowns
                document.querySelectorAll('.nav-dropdown.dropdown-open').forEach(dropdown => {
                    if (dropdown !== parentDropdown) dropdown.classList.remove('dropdown-open');
                });
                // Toggle this one and exit (no navigation)
                parentDropdown.classList.toggle('dropdown-open', !isOpen);
                return;
            }

            const frame = document.getElementById('contentFrame');
            const allLinks = document.querySelectorAll('.nav-link');

            // Remove active state from all links
            allLinks.forEach(link => { link.classList.remove('active'); link.removeAttribute('aria-current'); });

            // Add active class to clicked link
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Load content in iframe and persist selection
            frame.src = url;
            try { localStorage.setItem('codex:last', url); } catch(e) {}

            // Close menu after clicking a link
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.querySelector('.menu-backdrop');
            const toggleBtn = document.querySelector('.desktop-menu-toggle');
            sidebar.classList.remove('active');
            backdrop.classList.remove('active');
            toggleBtn.innerHTML = '☰';

            // Close all dropdowns when navigating
            document.querySelectorAll('.nav-dropdown.dropdown-open').forEach(dropdown => {
                dropdown.classList.remove('dropdown-open');
                const p = dropdown.querySelector('> .nav-link.has-submenu');
                if (p) p.setAttribute('aria-expanded', 'false');
            });
        }

        // Set home page as active on load
        window.addEventListener('DOMContentLoaded', function() {
            // No active state on load - home content is shown by default

            // Handle sidebar scroll indicator
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.addEventListener('scroll', function() {
                    const isAtBottom = (sidebar.scrollHeight - sidebar.scrollTop) <= (sidebar.clientHeight + 50);
                    if (isAtBottom) {
                        sidebar.style.setProperty('--scroll-indicator-opacity', '0');
                    } else {
                        sidebar.style.setProperty('--scroll-indicator-opacity', '0.8');
                    }
                });

                // Check initial scroll position
                const isScrollable = sidebar.scrollHeight > sidebar.clientHeight;
                if (!isScrollable) {
                    sidebar.style.setProperty('--scroll-indicator-opacity', '0');
                }
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                // Check if click is outside any dropdown
                const clickedDropdown = event.target.closest('.nav-dropdown');

                if (!clickedDropdown) {
                    // Clicked outside all dropdowns - close them all
                    document.querySelectorAll('.nav-dropdown.dropdown-open').forEach(dropdown => {
                        dropdown.classList.remove('dropdown-open');
                    });
                }
            });

            // Convert dropdown parents to toggles and inject parent links into submenu
            document.querySelectorAll('.nav-dropdown').forEach((dd, idx) => {
                const parent = dd.querySelector('.nav-link.has-submenu');
                const submenu = dd.querySelector('.nav-submenu');
                if (!parent || !submenu) return;

                // Move parent destination into data-url if present on onclick
                let url = parent.getAttribute('data-url');
                if (!url) {
                    const onclick = parent.getAttribute('onclick');
                    // Try to extract 'loadContent("X"' pattern
                    const m = onclick ? onclick.match(/loadContent\(['\"]([^'\"]+)['\"]/i) : null;
                    if (m) url = m[1];
                }
                if (url) parent.setAttribute('data-url', url);
                // Remove navigation from parent
                parent.removeAttribute('onclick');

                // Accessibility: treat parent as a toggle button
                parent.setAttribute('role', 'button');
                parent.setAttribute('tabindex', '0');
                // Ensure submenu has an id for aria-controls
                if (!submenu.id) submenu.id = `submenu-${idx+1}`;
                parent.setAttribute('aria-controls', submenu.id);
                parent.setAttribute('aria-expanded', 'false');

                // If first submenu item is not the parent link, inject it
                const first = submenu.querySelector('.nav-link');
                const label = (parent.textContent || '').trim();
                if (!first || (first && first.textContent.trim() !== label)) {
                    const a = document.createElement('a');
                    a.className = 'nav-link';
                    a.textContent = label;
                    if (url) a.dataset.url = url;
                    a.addEventListener('click', (ev) => loadContent(url || '#', ev));
                    submenu.insertBefore(a, submenu.firstChild);
                }

                // Click/keyboard toggle behavior for parent links
                function toggleDropdown(ev) {
                    if (ev) { ev.preventDefault(); ev.stopPropagation(); }
                    const isOpen = dd.classList.contains('dropdown-open');
                    document.querySelectorAll('.nav-dropdown.dropdown-open').forEach(other => {
                        if (other !== dd) {
                            other.classList.remove('dropdown-open');
                            const p = other.querySelector('> .nav-link.has-submenu');
                            if (p) p.setAttribute('aria-expanded', 'false');
                        }
                    });
                    dd.classList.toggle('dropdown-open', !isOpen);
                    parent.setAttribute('aria-expanded', String(!isOpen));
                }
                parent.addEventListener('click', toggleDropdown);
                parent.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ') toggleDropdown(ev);
                });
            });

            // Back-to-top FAB controls scrolling of iframe content and shows on scroll
            const frame = document.getElementById('contentFrame');
            const fab = document.getElementById('backToTopBtn');
            function updateFabVisibility() {
                try {
                    const y = frame.contentWindow.scrollY || frame.contentDocument.documentElement.scrollTop;
                    if (y > 400) fab.classList.add('visible'); else fab.classList.remove('visible');
                } catch(e) { /* cross-origin guard */ }
            }
            function attachScrollListener() {
                try {
                    frame.contentWindow.addEventListener('scroll', updateFabVisibility, { passive: true });
                    updateFabVisibility();
                } catch(e) { /* ignore */ }
            }

            // Inject smooth scrolling CSS and a #top anchor into iframe content
            function injectSmoothScroll() {
                try {
                    const doc = frame.contentDocument;
                    if (!doc) return;
                    // Ensure a #top anchor exists for in-page back-to-top links
                    if (!doc.getElementById('top')) {
                        const topAnchor = doc.createElement('div');
                        topAnchor.id = 'top';
                        topAnchor.style.position = 'absolute';
                        topAnchor.style.top = '0';
                        topAnchor.style.left = '0';
                        doc.body.insertBefore(topAnchor, doc.body.firstChild);
                    }
                    // Inject CSS only once per page load
                    if (!doc.getElementById('injected-smooth-scroll-style')) {
                        const style = doc.createElement('style');
                        style.id = 'injected-smooth-scroll-style';
                        style.textContent = `
                            html { scroll-behavior: smooth; }
                            /* Provide comfortable anchor offsets for headings */
                            h1, h2, h3, h4, h5, h6 { scroll-margin-top: 72px; }
                            /* Make any .back-to-top or anchor links feel responsive */
                            a[href^="#"] { cursor: pointer; }
                        `;
                        doc.head.appendChild(style);
                    }
                } catch(e) { /* cross-origin guard */ }
            }

            function onFrameLoad() {
                attachScrollListener();
                injectSmoothScroll();
                updateFabVisibility();
            }

            frame.addEventListener('load', onFrameLoad);
            onFrameLoad();
            fab.addEventListener('click', function() {
                try {
                    frame.contentWindow.scrollTo({ top: 0, behavior: 'smooth' });
                } catch(e) {
                    // fallback
                    frame.contentWindow.scrollTo(0,0);
                }
            });

            // Map all nav links to data-url for active state and restore
            function indexNavLinks() {
                document.querySelectorAll('a.nav-link').forEach(a => {
                    if (a.dataset.url) return;
                    const onclick = a.getAttribute('onclick');
                    const m = onclick ? onclick.match(/loadContent\(['\"]([^'\"]+)['\"]/i) : null;
                    if (m) a.dataset.url = m[1];
                });
            }
            indexNavLinks();

            // Helper: set active link by URL
            function setActiveByUrl(url) {
                const links = Array.from(document.querySelectorAll('a.nav-link'));
                links.forEach(l => { l.classList.remove('active'); l.removeAttribute('aria-current'); });
                const match = links.find(l => (l.dataset.url || '').replace(/#.*/, '') === (url || '').replace(/#.*/, ''));
                if (match) {
                    match.classList.add('active');
                    match.setAttribute('aria-current', 'page');
                }
            }

            // Restore last visited page on load
            try {
                const last = localStorage.getItem('codex:last');
                if (last && typeof last === 'string') {
                    document.getElementById('contentFrame').src = last;
                    setActiveByUrl(last);
                }
            } catch(e) {}

            // Update active state when iframe completes navigation
            frame.addEventListener('load', () => {
                try {
                    const current = frame.getAttribute('src');
                    if (current) setActiveByUrl(current);
                } catch(e) {}
            });

            // Sidebar quick search: filter, expand/collapse, clear
            const searchInput = document.getElementById('navSearchInput');
            const expandAllBtn = document.getElementById('expandAllBtn');
            const collapseAllBtn = document.getElementById('collapseAllBtn');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const navContent = document.querySelector('.nav-content');

            function normalize(text) { return (text || '').toLowerCase().trim(); }

            // Preserve original link text for reliable highlighting reset
            const allNavLinks = Array.from(navContent.querySelectorAll('a.nav-link'));
            allNavLinks.forEach(a => {
                if (!a.dataset.originalText) a.dataset.originalText = (a.textContent || '').trim();
            });

            function resetVisibility() {
                // Show everything and remove highlights
                navContent.querySelectorAll('.nav-section, .nav-dropdown, .nav-link').forEach(el => {
                    el.style.display = '';
                    el.classList.remove('match');
                });
                // Restore original texts (remove previous highlights)
                allNavLinks.forEach(a => { a.innerHTML = a.dataset.originalText || a.textContent; });
            }

            function highlightMatchText(a, query) {
                const text = a.dataset.originalText || a.textContent || '';
                const lower = text.toLowerCase();
                const idx = lower.indexOf(query);
                if (idx === -1) { a.innerHTML = text; return; }
                const before = text.slice(0, idx);
                const hit = text.slice(idx, idx + query.length);
                const after = text.slice(idx + query.length);
                a.innerHTML = `${before}<span class="nav-highlight">${hit}</span>${after}`;
            }

            function applySearchFilter(q) {
                const query = normalize(q);
                // If empty, reset and stop
                if (!query) {
                    resetVisibility();
                    // Do not force-expand/collapse here; leave as-is. Clear button will collapse.
                    return;
                }

                // Hide all by default; selectively show matches and their ancestors
                navContent.querySelectorAll('.nav-section, .nav-dropdown, .nav-link').forEach(el => {
                    el.style.display = 'none';
                    el.classList.remove('match');
                });

                // Track which sections should be visible
                const sections = Array.from(navContent.querySelectorAll('.nav-section'));
                const dropdowns = Array.from(navContent.querySelectorAll('.nav-dropdown'));
                const links = Array.from(navContent.querySelectorAll('a.nav-link'));

                // Helper: show element and its containing section
                function showWithAncestors(linkEl) {
                    linkEl.style.display = '';
                    linkEl.classList.add('match');
                    const dd = linkEl.closest('.nav-dropdown');
                    if (dd) {
                        dd.style.display = '';
                        dd.classList.add('dropdown-open');
                        const parentLink = dd.querySelector('.nav-link.has-submenu');
                        if (parentLink) parentLink.style.display = '';
                        const submenu = dd.querySelector('.nav-submenu');
                        if (submenu) submenu.style.display = '';
                    }
                    const section = linkEl.closest('.nav-section');
                    if (section) section.style.display = '';
                }

                // Find and show matches
                links.forEach(a => {
                    const text = normalize(a.textContent || '');
                    if ((a.dataset.originalText || text).toLowerCase().includes(query)) {
                        highlightMatchText(a, query);
                        showWithAncestors(a);
                    }
                });

                // Ensure dropdowns without matches are closed and hidden
                dropdowns.forEach(dd => {
                    const anyVisibleChild = !!dd.querySelector('.nav-submenu .nav-link.match');
                    const parentMatched = !!dd.querySelector('> .nav-link.has-submenu.match');
                    const hasAny = anyVisibleChild || parentMatched;
                    if (hasAny) {
                        dd.style.display = '';
                        dd.classList.add('dropdown-open');
                        const parentLink = dd.querySelector('> .nav-link.has-submenu');
                        if (parentLink) parentLink.setAttribute('aria-expanded', 'true');
                    } else {
                        dd.classList.remove('dropdown-open');
                        dd.style.display = 'none';
                        const parentLink = dd.querySelector('> .nav-link.has-submenu');
                        if (parentLink) parentLink.setAttribute('aria-expanded', 'false');
                    }
                });

                // Hide any empty sections with no visible content
                sections.forEach(sec => {
                    const anyVisible = !!sec.querySelector('a.nav-link.match');
                    sec.style.display = anyVisible ? '' : 'none';
                });
            }

            // Debounce to avoid excessive DOM work on fast typing
            function debounce(fn, wait) {
                let t;
                return function(...args) {
                    clearTimeout(t);
                    t = setTimeout(() => fn.apply(this, args), wait);
                };
            }
            const debouncedSearch = debounce((val) => applySearchFilter(val), 180);

            // Wire events
            if (searchInput) {
                searchInput.addEventListener('input', (e) => debouncedSearch(e.target.value));
            }
            // ESC collapses dropdowns and clears search
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (searchInput) searchInput.value = '';
                    resetVisibility();
                    document.querySelectorAll('.nav-dropdown').forEach(dd => dd.classList.remove('dropdown-open'));
                    document.querySelectorAll('.nav-dropdown > .nav-link.has-submenu').forEach(p => p.setAttribute('aria-expanded', 'false'));
                }
            });
            if (expandAllBtn) {
                expandAllBtn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-dropdown').forEach(dd => dd.classList.add('dropdown-open'));
                    document.querySelectorAll('.nav-dropdown > .nav-link.has-submenu').forEach(p => p.setAttribute('aria-expanded', 'true'));
                });
            }
            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-dropdown').forEach(dd => dd.classList.remove('dropdown-open'));
                    document.querySelectorAll('.nav-dropdown > .nav-link.has-submenu').forEach(p => p.setAttribute('aria-expanded', 'false'));
                });
            }
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    if (searchInput) searchInput.value = '';
                    resetVisibility();
                    // Default to collapsed view after clear
                    document.querySelectorAll('.nav-dropdown').forEach(dd => dd.classList.remove('dropdown-open'));
                    document.querySelectorAll('.nav-dropdown > .nav-link.has-submenu').forEach(p => p.setAttribute('aria-expanded', 'false'));
                });
            }
        });
    </script>
</body>
</html>
