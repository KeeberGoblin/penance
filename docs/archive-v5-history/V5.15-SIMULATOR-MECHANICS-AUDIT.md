# Simulator Mechanics Audit - v5.15

**Date:** October 20, 2025
**Audit Scope:** Combat simulator mechanics implementation vs. card database
**Simulator Version:** v5.14 (equipment_simulator_dice.py)
**Card Database Version:** 5.13

---

## Executive Summary

**CRITICAL FINDING:** The v5.14 simulator results are **partially inaccurate** because it uses artificial damage multipliers instead of implementing actual faction resource mechanics.

**Impact:**
- 5 out of 10 factions have non-functional or missing mechanics
- Win rates are driven by hardcoded multipliers, not card effects
- Balance changes based on v5.14 data would be misleading

**Required Action:** Implement missing mechanics BEFORE making any card-level balance changes.

---

## Mechanics Implementation Status

### ✅ FULLY IMPLEMENTED

#### 1. **Bleed System (Elves)**
- **Location:** Lines 750-757, 802-809
- **Status:** ✅ Working correctly
- **Details:**
  - Bleed applied on attack (not on hit)
  - 1 damage per stack per turn
  - Applied at turn start (unavoidable damage)
  - Caps at 4 stacks
  - Correctly parsed from card effect text

**Example Cards Working:**
- Leaf Blade Flurry (2×2 damage + Bleed 1 each)
- Barbed Arrow Volley (3 damage + Bleed 3)

---

#### 2. **Core Combat Mechanics**
- **Status:** ✅ All working
- **Implemented:**
  - Attack dice (custom d6 with JAM face)
  - Defense dice (6 symbols: Shield, Absorb, Wound, Critical, Pierce, Heat)
  - Catastrophic failure (double JAM) → weapon jam
  - Execution (double 5s) → auto-kill component
  - Critical hits (+2 damage, bypass 1 defense die)
  - Strong hits (+1 damage)
  - Weapon jamming (-2 damage next turn, +2 heat)
  - Component damage tracking (from Critical defense symbols)
  - Heat accumulation (from Heat defense symbols)

---

### ⚠️ PARTIALLY IMPLEMENTED

#### 3. **Forge Tokens (Crucible)**
- **Location:** Lines 204, 811-814
- **Status:** ⚠️ Generates but never spends
- **What Works:**
  - Tracks forge_tokens variable (max 5)
  - Gains 1 token on attack if card effect contains "forge" and "gain"
- **What's Missing:**
  - No spending logic for damage/defense bonuses
  - Ancestral Iron permanent upgrades not implemented
  - Forge Blessing defense not implemented
  - Emberforged Strike token spending not implemented

**Impact:** Crucible 80% WR is due to +90% damage multiplier (line 614), not Forge mechanics.

**Cards Not Working:**
- Ancestral Iron (5 tokens → permanent +1 stat)
- Forge Blessing (1 token → 3-5 damage reduction)
- Emberforged Strike (2 tokens → 7 damage + burn)
- Honor Duel (kill → 3 tokens + recover cards)

---

### ❌ NOT IMPLEMENTED

#### 4. **Biomass System (Bloodlines)**
- **Status:** ❌ No implementation at all
- **What's Missing:**
  - No biomass tracking variable in Casket class
  - No generation on Casket deaths (Vestige Heritage)
  - No spending for effects (Regenerative Flesh, mutations, etc.)
  - No event-driven resource generation system

**Impact:** Bloodlines 73% WR is due to +15% damage multiplier (line 611), not Biomass mechanics.

**Cards Not Working:**
- Vestige Heritage (passive Biomass on ANY Casket death)
- Devouring Maw (kill → +3 Biomass + recover 2 cards)
- Regenerative Flesh (spend Biomass → heal/recover)
- All mutation gambits (spend Biomass for effects)

**Required Implementation:**
```python
# Add to Casket class (line 170):
biomass_tokens: int = 0  # Current Biomass (max 10)

# Add to combat logic after kill:
def handle_casket_death(self, dead_casket, all_caskets):
    for casket in all_caskets:
        if casket.faction == "vestige-bloodlines":
            distance = abs(casket.range - dead_casket.range)
            if distance <= 6:
                casket.biomass_tokens = min(casket.biomass_tokens + 2, 10)

# Add to attack logic:
if 'spend' in card.effect and 'biomass' in card.effect:
    # Parse "Spend X Biomass" from effect
    biomass_cost = parse_biomass_cost(card.effect)
    if attacker.biomass_tokens >= biomass_cost:
        attacker.biomass_tokens -= biomass_cost
        # Apply card effect bonus
```

---

#### 5. **Credits System (Exchange)**
- **Status:** ❌ No implementation at all
- **What's Missing:**
  - No credits tracking variable in Casket class
  - No generation on attacks/hits
  - No spending for damage/effects
  - No economic warfare mechanics

**Impact:** Exchange 67% WR is due to +50% damage multiplier (line 612), not Credits mechanics.

**Cards Not Working:**
- Soul Contract (generate Credits)
- Buyout (spend Credits → remove enemy card)
- Hostile Takeover (spend Credits → damage/control)
- All "Spend X Credits" effects

**Required Implementation:**
```python
# Add to Casket class (line 170):
credit_tokens: int = 0  # Current Credits (max 10)

# Add to combat logic on successful attack:
if 'generate' in card.effect and 'credit' in card.effect.lower():
    credit_amount = parse_credit_generation(card.effect)
    attacker.credit_tokens = min(attacker.credit_tokens + credit_amount, 10)

# Add to attack logic:
if 'spend' in card.effect and 'credit' in card.effect.lower():
    credit_cost = parse_credit_cost(card.effect)
    if attacker.credit_tokens >= credit_cost:
        attacker.credit_tokens -= credit_cost
        # Apply card effect bonus
```

---

#### 6. **Rune Counters (Dwarves)**
- **Status:** ❌ No implementation at all
- **What's Missing:**
  - No rune_counters tracking variable
  - No component damage reduction system
  - No passive damage mitigation from runes
  - No rune generation mechanics

**Impact:** Dwarves 4% WR because they have NO working faction mechanics at all.

**Cards Not Working:**
- Rune of Protection (reduce damage by 1 per counter)
- Ironborn Resilience (ignore first component damage/turn)
- Ancestor Ward (prevent lethal, 1× per mission)
- All defensive rune cards

**Required Implementation:**
```python
# Add to Casket class (line 170):
rune_counters: int = 0  # Current rune counters (max 3)

# Add to damage calculation:
def take_damage(self, damage: int, defense_results: Dict[str, int]) -> int:
    # Existing shield/absorb blocks
    blocks = defense_results[DefenseDie.SHIELD] + defense_results[DefenseDie.ABSORB]

    # Add rune counter reduction
    if self.faction == "dwarves" and self.rune_counters > 0:
        rune_reduction = min(self.rune_counters, damage - blocks)
        blocks += rune_reduction
        self.rune_counters -= rune_reduction  # Consume counters

    final_damage = max(0, damage - blocks)
    # ... rest of damage logic
```

---

#### 7. **Self-Harm / Discard Mechanics (Church)**
- **Status:** ❌ No implementation at all
- **What's Missing:**
  - No discard-from-deck effects
  - No tracking of "cards discarded this turn"
  - No bonuses based on self-harm
  - No martyr/sacrifice mechanics

**Impact:** Church 13% WR because discard effects provide no benefit.

**Cards Not Working:**
- Blood Offering (discard 1 → +2 damage, LIMIT 1/turn)
- Penance Rune (+1 accuracy per discard)
- Martyrdom's Certainty (auto-hit, -2 damage)
- All self-sacrifice gambits

**Required Implementation:**
```python
# Add to Casket class (line 170):
discards_this_turn: int = 0  # Track self-harm for bonuses

# Add to turn reset:
def start_turn(self):
    self.discards_this_turn = 0
    # ... rest of turn logic

# Add to attack logic:
if 'discard' in card.effect.lower():
    discard_count = parse_discard_count(card.effect)
    for _ in range(discard_count):
        if attacker.deck:
            attacker.deck.popleft()  # Discard from deck
            attacker.discards_this_turn += 1

    # Apply discard bonus (e.g., +2 damage from Blood Offering)
    discard_bonus = parse_discard_bonus(card.effect)
    total_damage += discard_bonus
```

---

## The Damage Multiplier Problem

### Current Implementation (Lines 605-616)

The simulator uses **hardcoded faction damage multipliers** instead of implementing real mechanics:

```python
FACTION_DAMAGE_MULTIPLIER = {
    'church': 0.50,           # -50% damage
    'ossuarium': 0.60,        # -40% damage
    'dwarves': 0.75,          # -25% damage
    'elves': 0.80,            # -20% damage
    'wyrd-conclave': 1.00,    # No change
    'vestige-bloodlines': 1.15,  # +15% damage
    'exchange': 1.50,         # +50% damage
    'emergent': 1.70,         # +70% damage
    'crucible': 1.90,         # +90% damage
    'nomads': 2.50,           # +150% damage
}
```

### Why This Is Problematic

1. **Not testing real card effects** - Win rates reflect multipliers, not actual card mechanics
2. **Misleading balance data** - Changes based on this data would be incorrect
3. **Hides broken mechanics** - Bloodlines appears strong due to +15% multiplier, not Biomass
4. **Artificial balancing** - Band-aid fix instead of proper implementation

### Required Action

**After implementing all missing mechanics, remove all damage multipliers and retest with clean baseline.**

---

## Validation Testing Required

After implementing missing mechanics, run these tests:

### Test 1: Resource Generation
- **Bloodlines:** Kill enemy Casket within 6 hexes → verify Biomass gained
- **Crucible:** Attack with Living Forge card → verify Forge token gained
- **Exchange:** Use Soul Contract → verify Credits generated
- **Dwarves:** Use rune generation card → verify counter added

### Test 2: Resource Spending
- **Bloodlines:** Spend Biomass with Regenerative Flesh → verify cards recovered
- **Crucible:** Spend Forge with Emberforged Strike → verify bonus damage
- **Exchange:** Spend Credits with Buyout → verify effect applied
- **Dwarves:** Take damage with 3 rune counters → verify reduction applied

### Test 3: Self-Harm
- **Church:** Use Blood Offering (discard 1) → verify +2 damage bonus
- **Church:** Discard 3 times, use Penance Rune → verify +3 accuracy

### Test 4: Passive Effects
- **Elves:** Apply Bleed, wait 1 turn → verify unavoidable damage at turn start
- **Crucible:** Standing in lava terrain → verify 2 Forge tokens/turn

---

## Impact on v5.14 Results

### Factions with Accurate Results ✅
- **Elves** (29% WR) - Bleed implemented correctly, result is accurate
- **Wyrd** (42% WR) - No special mechanics, result likely accurate
- **Ossuarium** (51% WR) - No special mechanics, result likely accurate

### Factions with INACCURATE Results ❌
- **Dwarves** (4% WR) - Should be 30-40% with rune counters
- **Church** (13% WR) - Should be 40-50% with discard bonuses
- **Bloodlines** (73% WR) - Unknown actual WR with Biomass (could be higher or lower)
- **Exchange** (67% WR) - Unknown actual WR with Credits
- **Crucible** (80% WR) - Unknown actual WR with Forge spending (likely HIGHER due to Ancestral Iron)
- **Nomads** (76% WR) - 2.50× multiplier is artificial, true WR unknown
- **Emergent** (64% WR) - 1.70× multiplier is artificial, true WR unknown

---

## Recommended Action Plan

### Phase 1: Implement Missing Mechanics (Priority: CRITICAL)

**Week 1 - Core Resource Systems:**
1. Implement Rune Counters (Dwarves) - 4 hours
2. Implement Biomass System (Bloodlines) - 6 hours
3. Implement Credits System (Exchange) - 6 hours
4. Implement Forge Spending (Crucible) - 4 hours
5. Implement Discard Mechanics (Church) - 3 hours

**Total Time:** ~23 hours (3 work days)

### Phase 2: Remove Artificial Multipliers

**Week 1 - After mechanics done:**
1. Set all FACTION_DAMAGE_MULTIPLIER values to 1.00
2. Run new baseline v5.15a simulation (clean data)
3. Document true faction win rates

### Phase 3: Card-Level Balance

**Week 2 - Based on v5.15a results:**
1. Identify factions outside 45-55% WR range
2. Make targeted card changes (damage, cost, effects)
3. Run v5.15b simulation
4. Iterate until 7-8 factions balanced

### Phase 4: Advanced Mechanics

**Week 3+ - Optional enhancements:**
- Terrain effects (lava for Crucible)
- Support unit behavior
- Positioning/movement tactics
- Multi-target attacks
- Status effects (burn, poison, etc.)

---

## Files to Modify

### 1. `/workspaces/penance/simulation/equipment_simulator_dice.py`

**Lines to modify:**
- **170-196:** Casket class - Add resource tracking variables
- **605-616:** Remove FACTION_DAMAGE_MULTIPLIER or set all to 1.00
- **743-867:** execute_turn() - Add resource generation/spending logic
- **236-263:** take_damage() - Add rune counter damage reduction

**Estimated changes:** ~200 lines added/modified

### 2. `/workspaces/penance/docs/cards/complete-card-data.json`

**No changes needed yet** - Balance after mechanics implemented

### 3. `/workspaces/penance/docs/V5.15-MECHANICS-IMPLEMENTATION.md`

**Create new file** - Document implementation details and test results

---

## Testing Protocol

After each mechanic implementation:

1. **Unit Test:** Verify resource tracks correctly (print statements)
2. **Integration Test:** Run 1 faction vs 1 faction (10 battles)
3. **Validation:** Check resource generation/spending in logs
4. **Baseline Test:** Run full 225-battle simulation
5. **Document:** Record results in V5.15-MECHANICS-IMPLEMENTATION.md

---

## Expected Outcomes

### After Phase 1 (Mechanics Implemented)

**Predicted Win Rate Changes:**
- **Dwarves:** 4% → 35-45% (rune counters functional)
- **Church:** 13% → 40-50% (discard bonuses working)
- **Bloodlines:** 73% → 50-70% (Biomass may be strong or weak, unknown)
- **Crucible:** 80% → 60-90% (Forge spending + Ancestral Iron may be broken)
- **Exchange:** 67% → 40-60% (Credits should balance out)

### After Phase 3 (Card Balance)

**Target:** 7-8 factions in 45-55% WR range

---

## Conclusion

The v5.14 simulator is a **significant step forward** (complete deck system), but **not yet complete** (missing faction mechanics).

**Priority:** Implement missing mechanics BEFORE making any card-level balance changes. Current v5.14 results are only partially accurate.

**Timeline:** 2-3 weeks to full accuracy with proper testing.

---

**Document Version:** 1.0
**Author:** Claude (AI Assistant)
**Audit Type:** Code + database analysis
**Status:** ⚠️ CRITICAL FINDINGS - ACTION REQUIRED
